<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build Your Impactful Itinerary - Explore India</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/tailwind.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Add any page-specific styles here if needed */
        .planner-bg {
            background-color: #f8f9fa; /* Light grey background */
        }
        .itinerary-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border-left: 4px solid var(--border-color, #e5e7eb); /* Default border */
        }
        .itinerary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .tag-btn {
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
        }
        .tag-btn.active {
            /* Define active styles for tags */
            font-weight: bold;
        }
        .tag-community.active { background-color: #3b82f6; color: white; } /* Blue */
        .tag-eco.active { background-color: #10b981; color: white; } /* Green */
        .tag-culture.active { background-color: #f97316; color: white; } /* Orange */

         /* Styling for Date inputs */
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: invert(0.6); /* Makes the icon visible on light backgrounds */
        }

        .tooltip {
          position: relative;
          display: inline-block;
        }

        .tooltip .tooltiptext {
          visibility: hidden;
          width: 140px;
          background-color: #555;
          color: #fff;
          text-align: center;
          border-radius: 6px;
          padding: 5px 0;
          position: absolute;
          z-index: 1;
          bottom: 125%; /* Position above the button */
          left: 50%;
          margin-left: -70px; /* Center the tooltip */
          opacity: 0;
          transition: opacity 0.3s;
        }

        .tooltip .tooltiptext::after {
          content: "";
          position: absolute;
          top: 100%; /* At the bottom of the tooltip */
          left: 50%;
          margin-left: -5px;
          border-width: 5px;
          border-style: solid;
          border-color: #555 transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext {
          visibility: visible;
          opacity: 1;
        }
    </style>
</head>
<body class="font-sans text-dark bg-light flex flex-col min-h-screen">

    <!-- Header (Copied from index.html for consistency) -->
    <header class="bg-white shadow-md fixed w-full z-20"> <!-- Increased z-index for header -->
         <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <a href="index.html" class="text-2xl font-display font-bold text-primary">
                        Explore<span class="text-secondary">India</span>
                    </a>
                </div>
                <nav class="hidden md:flex space-x-8">
                    <a href="destinations.html" class="font-medium hover:text-primary transition-colors">Destinations</a>
                    <a href="experiences.html" class="font-medium hover:text-primary transition-colors">Experiences</a>
                    <a href="events.html" class="font-medium hover:text-primary transition-colors">Events</a>
                    <a href="map.html" class="font-medium hover:text-primary transition-colors">Interactive Map</a>
                    <a href="planner.html" class="font-medium text-primary transition-colors border-b-2 border-primary">Trip Planner</a> <!-- Highlight current page -->
                    <a href="stories.html" class="font-medium hover:text-primary transition-colors">Traveler Stories</a>
                </nav>
                <div class="md:hidden">
                    <button id="menu-toggle" class="text-dark focus:outline-none">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
        <!-- Mobile menu (Copied from index.html) -->
        <div id="mobile-menu" class="md:hidden hidden bg-white w-full py-4 px-6 shadow-lg">
             <nav class="flex flex-col space-y-4">
                <a href="destinations.html" class="font-medium hover:text-primary transition-colors">Destinations</a>
                <a href="experiences.html" class="font-medium hover:text-primary transition-colors">Experiences</a>
                <a href="events.html" class="font-medium hover:text-primary transition-colors">Events</a>
                <a href="map.html" class="font-medium hover:text-primary transition-colors">Interactive Map</a>
                <a href="planner.html" class="font-medium text-primary transition-colors">Trip Planner</a> <!-- Highlight current page -->
                <a href="stories.html" class="font-medium hover:text-primary transition-colors">Traveler Stories</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow pt-24 planner-bg"> <!-- Added padding-top to offset fixed header -->
        <div class="container mx-auto px-4 py-12">

            <h1 class="text-4xl font-display font-bold text-center mb-4">Plan Your Impactful Journey</h1>
            <p class="text-xl text-center text-gray-600 mb-12 max-w-3xl mx-auto">Build your personalized India itinerary step-by-step, focusing on experiences that make a positive difference.</p>

            <!-- Itinerary Builder Form -->
            <section class="mb-12 bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6">Add a Stop to Your Itinerary</h2>
                <form id="add-stop-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Destination -->
                    <div>
                        <label for="destination-select" class="block text-sm font-medium text-gray-700 mb-1">Destination</label>
                        <select id="destination-select" name="destination" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="" disabled selected>Select a destination...</option>
                            <!-- Options populated by JS -->
                        </select>
                    </div>

                    <!-- Dates -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date (Optional)</label>
                            <input type="date" id="start-date" name="startDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label for="end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date (Optional)</label>
                            <input type="date" id="end-date" name="endDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                    </div>

                    <!-- Notes/Activities -->
                    <div class="md:col-span-2">
                        <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">Notes / Activities / Impact Focus</label>
                        <textarea id="notes" name="notes" rows="3" placeholder="E.g., Visit artisan cooperative, take part in beach cleanup, learn block printing..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
                    </div>

                    <!-- Impact Tags -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tag this stop (Optional):</label>
                        <div class="flex flex-wrap gap-3">
                            <button type="button" class="tag-btn tag-community border border-blue-500 text-blue-500 px-3 py-1 rounded-full text-sm" data-tag="community">
                                <i class="fas fa-hands-helping mr-1"></i> Community Focus
                            </button>
                            <button type="button" class="tag-btn tag-eco border border-green-500 text-green-500 px-3 py-1 rounded-full text-sm" data-tag="eco">
                                <i class="fas fa-leaf mr-1"></i> Eco-Friendly
                            </button>
                            <button type="button" class="tag-btn tag-culture border border-orange-500 text-orange-500 px-3 py-1 rounded-full text-sm" data-tag="culture">
                                <i class="fas fa-landmark mr-1"></i> Cultural Immersion
                            </button>
                        </div>
                         <input type="hidden" id="tags" name="tags"> <!-- Hidden input to store selected tags -->
                    </div>

                    <!-- Add Button -->
                    <div class="col-span-1 md:col-span-2 flex justify-center mt-4"> <!-- Changed to span full width and center the button -->
                        <button type="submit" class="bg-secondary hover:bg-opacity-90 text-black font-medium px-8 py-3 rounded-lg transition-colors text-lg">
                            <i class="fas fa-plus mr-2"></i> Add Stop to Itinerary
                        </button>
                    </div>
                </form>
            </section>

            <!-- Virtual Passport Section -->
            <section id="passport-section" class="mb-12 bg-gradient-to-r from-blue-50 to-indigo-100 p-6 rounded-xl shadow-md">
                <h2 class="text-2xl font-bold mb-4 text-indigo-800"><i class="fas fa-passport mr-2"></i> Your Explorer Passport</h2>
                <div id="passport-badges" class="flex flex-wrap gap-4 items-center min-h-[40px]">
                    <!-- Badges will be added here by JS -->
                    <p id="no-badges-message" class="text-gray-500 italic text-sm">Add destinations from different regions to your itinerary to collect badges!</p>
                </div>
            </section>

            <!-- Itinerary Display -->
            <section>
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold">Your Itinerary</h2>
                    <div class="flex gap-3">
                        <!-- Action buttons moved here to be above itinerary list -->
                        <button id="generate-narrative" class="bg-purple-600 hover:bg-purple-700 text-white font-medium px-4 py-2 rounded-lg transition-colors text-sm tooltip disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                             <i class="fas fa-feather-alt mr-1"></i> Generate Narrative <span class="tooltiptext">Create a story for your trip</span>
                         </button>
                        <button id="show-route-map" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded-lg transition-colors text-sm tooltip disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                             <i class="fas fa-map-marked-alt mr-1"></i> Show Route on Map
                             <span class="tooltiptext">View the planned route</span>
                         </button>
                         <button id="clear-itinerary" class="bg-red-600 hover:bg-red-700 text-white font-medium px-4 py-2 rounded-lg transition-colors text-sm tooltip">
                             <i class="fas fa-trash-alt mr-1"></i> Clear All
                             <span class="tooltiptext">Remove all stops</span>
                         </button>
                    </div>
                </div>

                <div id="itinerary-list" class="space-y-6">
                    <!-- Itinerary stops will be dynamically added here -->
                    <p id="empty-itinerary-message" class="text-center text-gray-500 py-8">Your itinerary is currently empty. Add some stops using the form above!</p>
                </div>
            </section>

            <!-- Narrative Output Section -->
            <section id="narrative-section" class="mt-12 mb-6 hidden"> <!-- Hidden initially -->
                 <h2 class="text-2xl font-bold mb-4">Your Trip Narrative</h2>
                 <div id="narrative-output" class="bg-white p-6 rounded-lg shadow-md border-l-4 border-secondary text-gray-700 italic">
                     Click "Generate Trip Narrative" above to create a story for your journey!
                 </div>
            </section>

        </div>
    </main>

    <!-- Footer (Copied from index.html for consistency) -->
    <footer class="bg-dark text-light py-12 mt-auto">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
                <div>
                    <h4 class="text-lg font-bold mb-4 font-display">Explore<span class="text-secondary">India</span></h4>
                    <p class="text-sm text-gray-400">Your ultimate guide to discovering the culture, beauty, and spirit of India.</p>
                </div>
                <div>
                    <h5 class="text-md font-semibold mb-4">Quick Links</h5>
                    <nav class="flex flex-col space-y-2 text-sm">
                        <a href="destinations.html" class="hover:text-primary transition-colors">Destinations</a>
                        <a href="experiences.html" class="hover:text-primary transition-colors">Experiences</a>
                        <a href="events.html" class="hover:text-primary transition-colors">Events</a>
                        <a href="map.html" class="hover:text-primary transition-colors">Interactive Map</a>
                        <a href="planner.html" class="hover:text-primary transition-colors">Trip Planner</a>
                        <a href="stories.html" class="hover:text-primary transition-colors">Traveler Stories</a>
                    </nav>
                </div>
                <div>
                    <h5 class="text-md font-semibold mb-4">Connect With Us</h5>
                    <div class="flex space-x-4">
                        <a href="#" class="text-gray-400 hover:text-primary transition-colors"><i class="fab fa-facebook-f text-xl"></i></a>
                        <a href="#" class="text-gray-400 hover:text-primary transition-colors"><i class="fab fa-twitter text-xl"></i></a>
                        <a href="#" class="text-gray-400 hover:text-primary transition-colors"><i class="fab fa-instagram text-xl"></i></a>
                        <a href="#" class="text-gray-400 hover:text-primary transition-colors"><i class="fab fa-youtube text-xl"></i></a>
                    </div>
                     <h5 class="text-md font-semibold mt-6 mb-2">Newsletter</h5>
                     <form class="flex">
                         <input type="email" placeholder="Your email" class="flex-grow px-3 py-2 rounded-l-lg text-sm text-dark focus:outline-none">
                         <button class="bg-primary hover:bg-opacity-90 text-white px-4 py-2 rounded-r-lg text-sm font-medium transition-colors">Subscribe</button>
                     </form>
                </div>
                 <div>
                    <h5 class="text-md font-semibold mb-4">Contact Info</h5>
                     <ul class="text-sm text-gray-400 space-y-2">
                        <li><i class="fas fa-map-marker-alt mr-2 text-primary"></i> 123 Travel St, New Delhi, India</li>
                        <li><i class="fas fa-phone-alt mr-2 text-primary"></i> +91 123 456 7890</li>
                        <li><i class="fas fa-envelope mr-2 text-primary"></i> info@exploreindia.com</li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-gray-700 pt-8 text-center text-sm text-gray-500">
                &copy; 2024 ExploreIndia. All Rights Reserved. | <a href="#" class="hover:text-primary">Privacy Policy</a> | <a href="#" class="hover:text-primary">Terms of Service</a>
            </div>
        </div>
    </footer>

    <!-- Script for Mobile Menu Toggle (Copied from index.html) -->
    <script>
        const menuToggle = document.getElementById('menu-toggle');
        const mobileMenu = document.getElementById('mobile-menu');
        if (menuToggle && mobileMenu) {
            menuToggle.addEventListener('click', function() {
                mobileMenu.classList.toggle('hidden');
            });
        }
    </script>

    <!-- Planner JavaScript -->
    <script>
        // Define destinations (Ideally, this would be fetched or shared from a central JS file)
        const destinations = [
             { 
                name: "Taj Mahal, Agra", 
                coords: [27.1751, 78.0421], 
                region: "north",
                narrativeBits: ["the breathtaking symbol of eternal love", "Mughal architectural marvel", "gleaming white marble", "UNESCO World Heritage site"]
             },
             { 
                name: "Varanasi", 
                coords: [25.3176, 83.0130], 
                region: "north",
                narrativeBits: ["one of the world's oldest living cities", "the spiritual heart of India", "sacred Ganges river ghats", "ancient temples and rituals"]
             },
             { 
                name: "Kerala Backwaters", 
                coords: [9.4981, 76.3388], 
                region: "south",
                narrativeBits: ["tranquil palm-lined canals", "serene houseboat journeys", "lush greenery of 'God's Own Country'", "unique ecosystem"]
            },
             { 
                name: "Jaipur", 
                coords: [26.9124, 75.7873], 
                region: "north",
                narrativeBits: ["the vibrant 'Pink City'", "majestic forts and palaces", "bustling colorful bazaars", "royal Rajasthani heritage"]
            },
             { 
                name: "Goa Beaches", 
                coords: [15.2993, 74.1240], 
                region: "west",
                narrativeBits: ["sun-kissed sandy shores", "India's relaxed beach paradise", "Portuguese colonial influences", "vibrant nightlife"]
             },
             { 
                name: "Darjeeling", 
                coords: [27.0410, 88.2663], 
                region: "east",
                narrativeBits: ["misty Himalayan hill station", "world-famous tea gardens", "stunning Kanchenjunga views", "historic 'Toy Train' ride"]
             },
             { 
                name: "Delhi", 
                coords: [28.6139, 77.2090], 
                region: "north",
                narrativeBits: ["India's bustling capital city", "a fusion of ancient and modern", "historic monuments like Humayun's Tomb", "vibrant street food scene"]
             },
             { 
                name: "Mumbai", 
                coords: [19.0760, 72.8777], 
                region: "west",
                narrativeBits: ["India's energetic financial hub", "iconic Gateway of India", "the heart of Bollywood cinema", "colonial-era architecture"]
             },
             { 
                name: "Udaipur", 
                coords: [24.5854, 73.7125], 
                region: "north",
                narrativeBits: ["the romantic 'City of Lakes'", "stunning lakeside palaces", "intricate Rajasthani artwork", "serene boat rides on Lake Pichola"]
             },
             { 
                name: "Kolkata", 
                coords: [22.5726, 88.3639], 
                region: "east",
                narrativeBits: ["India's cultural capital", "colonial grandeur of the Victoria Memorial", "rich literary and artistic heritage", "unique tram network"]
             }
             // Add more destinations if needed, each with a narrativeBits array
        ];

        const itineraryList = document.getElementById('itinerary-list');
        const addStopForm = document.getElementById('add-stop-form');
        const destinationSelect = document.getElementById('destination-select');
        const emptyMessage = document.getElementById('empty-itinerary-message');
        const clearButton = document.getElementById('clear-itinerary');
        const hiddenTagsInput = document.getElementById('tags');
        const tagButtons = document.querySelectorAll('.tag-btn');
        const showRouteButton = document.getElementById('show-route-map'); // New button selector
        const narrativeSection = document.getElementById('narrative-section');
        const narrativeOutput = document.getElementById('narrative-output');
        // Find the container for the action buttons to add the new button
        const itineraryActionsContainer = document.querySelector('#itinerary-list').previousElementSibling.querySelector('.flex.gap-3');
        const passportBadgesContainer = document.getElementById('passport-badges');
        const noBadgesMessage = document.getElementById('no-badges-message');
        // Get the statically defined Generate Narrative button
        const generateNarrativeButton = document.getElementById('generate-narrative'); 

        // Define badge data for each region
        const regionBadges = {
            north: { name: 'Northern Explorer', icon: 'fas fa-snowflake', bgColor: 'bg-blue-100', color: 'text-blue-800' },
            south: { name: 'Southern Voyager', icon: 'fas fa-umbrella-beach', bgColor: 'bg-green-100', color: 'text-green-800' },
            east: { name: 'Eastern Adventurer', icon: 'fas fa-sun', bgColor: 'bg-yellow-100', color: 'text-yellow-800' },
            west: { name: 'Western Pioneer', icon: 'fas fa-wind', bgColor: 'bg-red-100', color: 'text-red-800' },
            central: { name: 'Central Discoverer', icon: 'fas fa-heart', bgColor: 'bg-purple-100', color: 'text-purple-800' }
        };

        let itinerary = []; // Array to hold itinerary stops

        // --- Populate Destination Dropdown ---
        destinations.forEach(dest => {
            const option = document.createElement('option');
            option.value = dest.name;
            option.textContent = dest.name;
            destinationSelect.appendChild(option);
        });

        // --- Tag Button Logic ---
        let selectedTags = [];
        tagButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tag = button.getAttribute('data-tag');
                button.classList.toggle('active');
                if (button.classList.contains('active')) {
                    selectedTags.push(tag);
                } else {
                    selectedTags = selectedTags.filter(t => t !== tag);
                }
                hiddenTagsInput.value = JSON.stringify(selectedTags); // Store as JSON string
            });
        });

        // --- Helper Functions ---
        // Function to get coordinates from destination name
        function getCoordsByName(name) {
            const dest = destinations.find(d => d.name === name);
            return dest ? dest.coords : null;
        }

        // Haversine distance calculation (from map.html)
        function calculateDistance(coords1, coords2) {
             if (!coords1 || !coords2) return null;

            const lat1 = coords1[0] * Math.PI / 180;
            const lat2 = coords2[0] * Math.PI / 180;
            const lon1 = coords1[1] * Math.PI / 180;
            const lon2 = coords2[1] * Math.PI / 180;

            const R = 6371; // Earth radius in km
            const dLat = lat2 - lat1;
            const dLon = lon2 - lon1;

            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1) * Math.cos(lat2) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            return Math.round(distance);
        }

        // Travel time estimation (adapted from map.html)
        function estimateTravelTime(distance) {
            if (distance === null) return "N/A";
            if (distance < 1) return "~5 min"; // Very short

            let hours;
            let mode;
            if (distance < 50) {
                hours = distance / 40; // Avg speed 40 km/h
                mode = "by car";
            } else if (distance < 300) {
                hours = distance / 60; // Avg speed 60 km/h
                mode = "by car/train";
            } else {
                hours = (distance / 700) + 1.5; // Avg speed 700 km/h + check-in/out
                mode = "by flight";
            }

            if (hours < 1) {
                 return `~${Math.round(hours * 60)} min ${mode}`;
            } else {
                 return `~${hours.toFixed(1)} hours ${mode}`;
            }
        }

        // New function to calculate and display travel info for a specific stop
        function calculateAndDisplayTravelInfo(index) {
             if (index === 0 || !itinerary[index] || !itinerary[index - 1]) return;

             const currentStop = itinerary[index];
             const previousStop = itinerary[index - 1];

             const coordsCurrent = getCoordsByName(currentStop.destination);
             const coordsPrevious = getCoordsByName(previousStop.destination);

             const distanceSpan = document.getElementById(`travel-distance-${index}`);
             const timeSpan = document.getElementById(`travel-time-${index}`);

             if (coordsCurrent && coordsPrevious && distanceSpan && timeSpan) {
                 const distance = calculateDistance(coordsPrevious, coordsCurrent);
                 const time = estimateTravelTime(distance);

                 distanceSpan.innerHTML = `<i class="fas fa-road mr-1"></i> Distance: ${distance !== null ? distance + ' km' : 'N/A'}`;
                 timeSpan.innerHTML = `<i class="far fa-clock mr-1"></i> Time: ${time}`;
             } else {
                 if (distanceSpan) distanceSpan.innerHTML = `<i class="fas fa-road mr-1"></i> Distance: N/A`;
                 if (timeSpan) timeSpan.innerHTML = `<i class="far fa-clock mr-1"></i> Time: N/A`;
                 console.warn(`Could not find coordinates for calculation between ${previousStop.destination} and ${currentStop.destination}`);
             }
        }

        // --- Core Functions ---
        function renderItinerary() {
            itineraryList.innerHTML = ''; // Clear current list

            if (itinerary.length === 0) {
                emptyMessage.style.display = 'block';
                itineraryList.appendChild(emptyMessage);
            } else {
                emptyMessage.style.display = 'none';
                itinerary.forEach((stop, index) => {
                    const card = document.createElement('div');
                    card.className = 'itinerary-card bg-white p-6 rounded-lg shadow-md flex flex-col md:flex-row justify-between items-start gap-4';
                    
                    let tagsHTML = '';
                    if (stop.tags && stop.tags.length > 0) {
                        tagsHTML = stop.tags.map(tag => {
                            let iconClass = '';
                            let tagClass = '';
                            let tagName = '';
                            switch(tag) {
                                case 'community': iconClass = 'fas fa-hands-helping'; tagClass='bg-blue-100 text-blue-700'; tagName='Community'; break;
                                case 'eco': iconClass = 'fas fa-leaf'; tagClass='bg-green-100 text-green-700'; tagName='Eco'; break;
                                case 'culture': iconClass = 'fas fa-landmark'; tagClass='bg-orange-100 text-orange-700'; tagName='Culture'; break;
                            }
                            return `<span class="inline-block ${tagClass} text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full"><i class="${iconClass} mr-1"></i>${tagName}</span>`;
                        }).join('');
                    }

                    let datesHTML = '';
                    if (stop.startDate || stop.endDate) {
                       const start = stop.startDate ? new Date(stop.startDate).toLocaleDateString() : 'N/A';
                       const end = stop.endDate ? new Date(stop.endDate).toLocaleDateString() : 'N/A';
                       datesHTML = `<p class="text-sm text-gray-500 mt-1"><i class="far fa-calendar-alt mr-1"></i> ${start} - ${end}</p>`;
                    }

                    const notesHTML = stop.notes ? `<p class="text-gray-700 mt-3 mb-3">${stop.notes.replace(/\n/g, '<br>')}</p>` : '';
                    let travelInfoHTML = '';
                    if (index > 0) {
                        travelInfoHTML = `
                        <div class="mt-3 pt-3 border-t border-gray-200 text-sm text-gray-600">
                            <p class="font-medium mb-1"><i class="fas fa-route mr-1"></i> Journey from ${itinerary[index-1].destination}:</p>
                            <span id="travel-distance-${index}" class="mr-2"><i class="fas fa-road mr-1"></i> Distance: calculating...</span>
                            <span id="travel-time-${index}"><i class="far fa-clock mr-1"></i> Time: calculating...</span>
                        </div>
                        `;
                    }

                    // Get coordinates for the "Find Nearby" button
                    const stopCoords = getCoordsByName(stop.destination);
                    const coordsString = stopCoords ? stopCoords.join(',') : ''; // Format as comma-separated string

                    card.innerHTML = `
                        <div class="flex-grow">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-xl font-bold text-primary">${index + 1}. ${stop.destination}</h3>
                                <button class="delete-stop-btn text-red-500 hover:text-red-700 text-sm font-medium tooltip" data-index="${index}">
                                    <i class="fas fa-times-circle text-lg"></i>
                                    <span class="tooltiptext">Remove stop</span>
                                </button>
                            </div>
                            ${datesHTML}
                            ${notesHTML}
                            ${tagsHTML ? `<div class="mt-3">${tagsHTML}</div>` : ''}
                            ${travelInfoHTML}
                            <!-- Find Nearby Button -->
                            <div class="mt-3 pt-3 border-t border-gray-100">
                                <button class="find-nearby-btn bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-medium px-3 py-1 rounded ${!coordsString ? 'opacity-50 cursor-not-allowed' : ''}" 
                                        data-coords="${coordsString}" 
                                        ${!coordsString ? 'disabled' : ''}>
                                    <i class="fas fa-search-location mr-1"></i> Find Nearby on Map
                                </button>
                            </div>
                        </div>
                    `;

                    if (stop.tags && stop.tags.length > 0) {
                        card.style.borderLeftColor = getTagColor(stop.tags[0]);
                        card.style.borderLeftWidth = '4px';
                    }

                    itineraryList.appendChild(card);

                    // Calculate and display travel info AFTER the card is added to the DOM
                    if (index > 0) {
                        calculateAndDisplayTravelInfo(index);
                    }
                });

                // Re-attach delete listeners and add Find Nearby listeners
                attachActionListeners();
            }

            // Enable/disable Show Route button based on itinerary length
            if (itinerary.length >= 2) {
                showRouteButton.disabled = false;
            } else {
                showRouteButton.disabled = true;
            }

            // Enable/disable Action Buttons based on itinerary length
            const hasEnoughStops = itinerary.length >= 2;
            // Make sure buttons exist before setting disabled property
            if (showRouteButton) showRouteButton.disabled = !hasEnoughStops;
            if (generateNarrativeButton) generateNarrativeButton.disabled = !hasEnoughStops; 

            // Show/Hide narrative section based on itinerary existence
             narrativeSection.classList.toggle('hidden', itinerary.length === 0);

            // Update passport badges after rendering itinerary
            updatePassportBadges(); 
        }

        function attachActionListeners() {
             // Delete buttons
            document.querySelectorAll('.delete-stop-btn').forEach(button => {
                button.removeEventListener('click', handleDeleteClick); // Prevent duplicate listeners
                button.addEventListener('click', handleDeleteClick);
            });
            // Find Nearby buttons
            document.querySelectorAll('.find-nearby-btn').forEach(button => {
                button.removeEventListener('click', handleFindNearbyClick); // Prevent duplicate listeners
                button.addEventListener('click', handleFindNearbyClick);
            });
        }

        function handleDeleteClick(e) {
            const targetButton = e.target.closest('.delete-stop-btn');
            if (targetButton) {
                const indexToDelete = parseInt(targetButton.getAttribute('data-index'), 10);
                deleteStop(indexToDelete);
            }
        }

        function handleFindNearbyClick(e) {
            const targetButton = e.target.closest('.find-nearby-btn');
            const coords = targetButton.getAttribute('data-coords');
            if (coords) {
                localStorage.setItem('findNearbyLocation', coords); // Store coords string
                window.location.href = 'map.html';
            } else {
                alert("Could not get coordinates for this location.");
            }
        }

        function getTagColor(tag) {
             switch(tag) {
                case 'community': return '#3b82f6'; // Blue
                case 'eco': return '#10b981'; // Green
                case 'culture': return '#f97316'; // Orange
                default: return '#e5e7eb'; // Default gray
            }
        }

        function addStop(event) {
            event.preventDefault();
            const formData = new FormData(addStopForm);
            const newStop = {
                destination: formData.get('destination'),
                startDate: formData.get('startDate'),
                endDate: formData.get('endDate'),
                notes: formData.get('notes'),
                tags: selectedTags // Use the tracked selected tags
                // tags: JSON.parse(formData.get('tags') || '[]') // Get tags from hidden input
            };

            // Basic validation
            if (!newStop.destination) {
                 alert("Please select a destination.");
                 return;
            }

             // Date validation (optional: ensure end date is after start date)
             if (newStop.startDate && newStop.endDate && new Date(newStop.endDate) < new Date(newStop.startDate)) {
                 alert("End date cannot be before start date.");
                 return;
             }

            itinerary.push(newStop);
            saveItinerary();
            renderItinerary();
            addStopForm.reset(); // Clear the form
            // Reset tag buttons visually and clear selectedTags array
            tagButtons.forEach(btn => btn.classList.remove('active'));
            selectedTags = [];
            hiddenTagsInput.value = '';
        }

        function deleteStop(index) {
            if (index >= 0 && index < itinerary.length) {
                itinerary.splice(index, 1);
                saveItinerary();
                renderItinerary();
            }
        }

        function saveItinerary() {
            localStorage.setItem('userItinerary', JSON.stringify(itinerary));
        }

        function loadItinerary() {
            const savedItinerary = localStorage.getItem('userItinerary');
            if (savedItinerary) {
                itinerary = JSON.parse(savedItinerary);
            }
            renderItinerary(); // Render loaded or empty itinerary
        }

         function clearAll() {
             if (confirm("Are you sure you want to clear the entire itinerary? This cannot be undone.")) {
                itinerary = [];
                localStorage.removeItem('userItinerary');
                renderItinerary();
             }
         }

        // --- New Function for Showing Route ---
        function showRouteOnMap() {
            if (itinerary.length < 2) {
                alert("Please add at least two stops to show a route.");
                return;
            }

            const routeCoordinates = itinerary.map(stop => getCoordsByName(stop.destination)).filter(coords => coords !== null);

            if (routeCoordinates.length < 2) {
                alert("Could not find coordinates for enough stops to draw a route.");
                return;
            }

            // Store coordinates in localStorage
            localStorage.setItem('itineraryRouteData', JSON.stringify(routeCoordinates));

            // Redirect to map page
            window.location.href = 'map.html';
        }

        // --- Narrative Generation Logic ---
        function generateNarrative() {
            if (itinerary.length < 2) {
                narrativeOutput.innerHTML = "Add at least two stops to your itinerary to generate a narrative.";
                narrativeSection.classList.remove('hidden');
                return;
            }

            // Expanded and categorized transition phrases
            const startPhrase = "Your adventure begins in";
            const midTransitionPhrases = [
                "From there, your path leads you to",
                "Next, journey onward to",
                "Continuing your exploration, you arrive at",
                "The next chapter unfolds in",
                "Experience the contrast as you move to",
                "Prepare to explore the unique character of"
            ];
             const regionChangePhrase = "Venturing into {region} India, you'll find yourself in";
             const finalTransitionPhrases = [
                 "Your journey culminates in",
                 "The final leg of your adventure takes you to",
                 "Concluding your exploration at"
             ];
             
            const tagPhrases = {
                community: ["connecting with local artisans", "experiencing authentic community life", "supporting local initiatives"],
                eco: ["while embracing sustainable practices", "treading lightly on the beautiful landscape", "focusing on eco-conscious travel"],
                culture: ["diving deep into the rich traditions", "uncovering layers of cultural heritage", "soaking in the artistic atmosphere"]
            };

            let narrative = "";
            let previousRegion = null;
            const uniqueRegions = new Set();
            const tagCounts = { community: 0, eco: 0, culture: 0 };

            itinerary.forEach((stop, index) => {
                const destData = destinations.find(d => d.name === stop.destination);
                if (!destData) return; 

                uniqueRegions.add(destData.region); // Collect regions for conclusion
                if (stop.tags) stop.tags.forEach(tag => { if(tagCounts[tag] !== undefined) tagCounts[tag]++; }); // Count tags

                let sentence = "";
                let currentTransition = "";

                // 1. Determine Transition Phrase
                if (index === 0) {
                    currentTransition = startPhrase;
                } else if (index === itinerary.length - 1) { // Final stop
                    currentTransition = finalTransitionPhrases[Math.floor(Math.random() * finalTransitionPhrases.length)];
                } else { // Mid stops
                    if (previousRegion && destData.region !== previousRegion) {
                        currentTransition = regionChangePhrase.replace("{region}", destData.region);
                    } else {
                        currentTransition = midTransitionPhrases[Math.floor(Math.random() * midTransitionPhrases.length)];
                    }
                }
                sentence += `${currentTransition} **${stop.destination}**, `;

                // 2. Add a random narrative bit
                if (destData.narrativeBits && destData.narrativeBits.length > 0) {
                    const bit = destData.narrativeBits[Math.floor(Math.random() * destData.narrativeBits.length)];
                    sentence += `${bit}`;
                }

                // 3. Add phrase based on the *first* selected tag for the stop
                if (stop.tags && stop.tags.length > 0) {
                    const firstTag = stop.tags[0];
                    if (tagPhrases[firstTag] && tagPhrases[firstTag].length > 0) {
                        const tagPhrase = tagPhrases[firstTag][Math.floor(Math.random() * tagPhrases[firstTag].length)];
                        sentence += `, ${tagPhrase}`; 
                    }
                }

                sentence += ". "; 
                narrative += sentence;
                previousRegion = destData.region; 
            });
            
            // Create a more dynamic concluding sentence
            let conclusion = "";
            const regionsVisited = Array.from(uniqueRegions).map(r => r.charAt(0).toUpperCase() + r.slice(1)); // Capitalize
            const regionString = regionsVisited.length > 1 
                                ? regionsVisited.slice(0, -1).join(', ') + ' and ' + regionsVisited.slice(-1)
                                : regionsVisited[0] || '';

            // Find dominant tag if any
            let dominantTag = null;
            let maxCount = 1; // Only consider if tag appears more than once
            for (const tag in tagCounts) {
                if (tagCounts[tag] > maxCount) {
                    maxCount = tagCounts[tag];
                    dominantTag = tag;
                }
            }

            conclusion = `This journey through ${regionString} India promises unforgettable memories`;
            if (dominantTag) {
                let focus = "";
                 switch(dominantTag) {
                     case 'community': focus = "a strong focus on community engagement"; break;
                     case 'eco': focus = "an emphasis on sustainable exploration"; break;
                     case 'culture': focus = "a deep dive into cultural heritage"; break;
                 }
                 conclusion += `, with ${focus}.`;
            } else {
                 conclusion += ".";
            }
            
            narrative += conclusion; 

            // Display the narrative
            narrativeOutput.innerHTML = narrative.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); 
            narrativeSection.classList.remove('hidden'); 
            narrativeOutput.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); 
        }

        // --- New Passport Badge Logic ---
        function updatePassportBadges() {
            const earnedRegions = new Set();
            itinerary.forEach(stop => {
                const destData = destinations.find(d => d.name === stop.destination);
                if (destData && destData.region) {
                    earnedRegions.add(destData.region);
                }
            });

            // Clear current badges
            passportBadgesContainer.innerHTML = ''; 

            if (earnedRegions.size === 0) {
                // Show the placeholder message if it exists
                if(noBadgesMessage) passportBadgesContainer.appendChild(noBadgesMessage);
            } else {
                 // Hide placeholder if it was added manually and badges exist
                 if (noBadgesMessage && noBadgesMessage.parentNode === passportBadgesContainer) {
                     passportBadgesContainer.removeChild(noBadgesMessage);
                 }
                // Add earned badges
                earnedRegions.forEach(region => {
                    const badgeData = regionBadges[region];
                    if (badgeData) {
                        const badgeElement = document.createElement('span');
                        badgeElement.className = `tooltip inline-flex items-center justify-center ${badgeData.bgColor} ${badgeData.color} rounded-full w-10 h-10 text-xl shadow-sm`;
                        badgeElement.innerHTML = `
                            <i class="${badgeData.icon}"></i>
                            <span class="tooltiptext">${badgeData.name}</span>
                        `;
                        passportBadgesContainer.appendChild(badgeElement);
                    }
                });
            }
        }

        // --- Event Listeners ---
        addStopForm.addEventListener('submit', addStop);
        clearButton.addEventListener('click', clearAll);
        // Add listeners only if the buttons exist
        if (showRouteButton) showRouteButton.addEventListener('click', showRouteOnMap);
        if (generateNarrativeButton) generateNarrativeButton.addEventListener('click', generateNarrative); 

        // --- Initial Load ---
        loadItinerary();

    </script>

    <!-- Chat Feature -->
    <script src="js/chat.js"></script>

    <!-- Chatbot Button -->
    <button type="button" id="chat-toggle-button" class="fixed bottom-5 right-5 bg-primary hover:bg-opacity-90 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg z-30 transition-transform transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
        <i class="fas fa-comments text-2xl"></i>
    </button>

    <!-- Chatbot Window -->
    <div id="chat-window" class="hidden fixed bottom-20 right-5 w-full max-w-sm sm:w-80 h-[65vh] sm:h-96 bg-white rounded-lg shadow-xl z-40 flex flex-col overflow-hidden border border-gray-200">
        <!-- Header -->
        <div class="bg-gradient-to-r from-primary to-blue-600 text-white p-3 flex justify-between items-center shadow-sm">
             <div class="flex items-center gap-2">
                 <!-- Icon background white, icon color blue-800 -->
                 <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-white text-blue-800 shadow-inner">
                    <i class="fas fa-robot text-base"></i> 
                 </span>
                 <h3 class="font-semibold text-base">Travel Assistant</h3>
             </div>
            <button id="chat-close-button" class="text-white hover:text-gray-200 focus:outline-none">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <!-- Messages -->
        <div id="chat-messages" class="flex-grow p-4 overflow-y-auto space-y-4 bg-gray-50">
            <!-- Messages will be added here -->
             <div class="chat-bubble bot"><p>Welcome! How can I help you plan your India trip today?</p></div>
        </div>
        <!-- Input -->
        <div class="p-3 border-t border-gray-200 bg-white">
            <form id="chat-form" class="flex gap-2">
                <input type="text" id="chat-input" placeholder="Ask anything..." class="flex-grow px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-primary shadow-sm">
                <button type="submit" class="bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-primary shadow-sm transition-colors">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>

</body>
</html> 